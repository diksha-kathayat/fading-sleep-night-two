<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sleep Tracker: Night 2+</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 p-6">
    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl p-8 border border-indigo-50">
        <div id="status-badge"
            class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-4"></div>

        <div class="border-2 border-dashed border-indigo-100 rounded-2xl p-6 text-center">
            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Prescribed Bedtime</p>
            <div id="res-bed" class="text-6xl font-extrabold text-slate-800">--:--</div>
            <p class="text-[10px] font-bold text-slate-400 uppercase mt-4">Wake Up: <span id="res-wake">--:--</span></p>
        </div>

        <div class="mt-6 p-4 bg-slate-50 rounded-xl">
            <p id="logic-text" class="text-xs text-slate-600 italic leading-relaxed text-center"></p>
        </div>
    </div>

    <script>
        const p = new URLSearchParams(window.location.search);
        const tToM = (t) => { if (!t) return 0; const [h, m] = t.split(':').map(Number); return (h * 60) + m; };
        const mToT = (m) => { let tm = Math.round(m); while (tm < 0) tm += 1440; return String(Math.floor(tm / 60) % 24).padStart(2, '0') + ":" + String(tm % 60).padStart(2, '0'); };

        function update() {
            const prevBed = p.get('prev_bed');
            const sol2 = parseInt(p.get('sol_val') || 0);
            const waso2 = parseInt(p.get('waso_val') || 0);

            // Check if "First Night" data exists in URL
            const hasFirstNight = p.has('first_sol');
            const badge = document.getElementById('status-badge');
            const logic = document.getElementById('logic-text');

            let finalBedMins = tToM(prevBed);

            if (!hasFirstNight) {
                // NIGHT 2 LOGIC
                badge.innerText = "Night 2: Static Phase";
                badge.classList.add('bg-blue-100', 'text-blue-700');
                logic.innerText = "One night of data collected. Keeping bedtime static for Night 2 to confirm baseline.";
            } else {
                // NIGHT 3+ LOGIC
                const sol1 = parseInt(p.get('first_sol'));
                const waso1 = parseInt(p.get('first_waso'));
                const avgSol = (sol1 + sol2) / 2;
                const avgWaso = (waso1 + waso2) / 2;

                badge.innerText = "Night 3+: Adjustment Phase";
                badge.classList.add('bg-emerald-100', 'text-emerald-700');

                if (avgSol <= 15 && avgWaso <= 15) {
                    finalBedMins -= 15;
                    logic.innerHTML = `Success! Avg SOL/WASO is ${avgSol}/${avgWaso}m. <br>Bedtime moved 15m earlier.`;
                } else {
                    finalBedMins += 15;
                    logic.innerHTML = `Avg SOL/WASO is ${avgSol}/${avgWaso}m. <br>Bedtime moved 15m later to increase sleep drive.`;
                }
            }

            document.getElementById('res-bed').innerText = mToT(finalBedMins);
            document.getElementById('res-wake').innerText = p.get('prev_wake') || "07:00";
        }
        window.onload = update;
    </script>
</body>

</html>