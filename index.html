<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sleep Intervention: Rolling Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');

        html,
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .math-font {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>

<body class="p-4">
    <div class="max-w-xl mx-auto space-y-4">
        <div class="bg-transparent p-4 text-center border-b border-slate-100 pb-6">
            <div id="status-tag"
                class="inline-block px-4 py-1 rounded-full text-[10px] font-black uppercase mb-4 tracking-widest bg-emerald-600 text-white">
                Rolling Adjustment Active
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 rounded-3xl bg-white border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mb-1">Target Bedtime</p>
                    <div id="res-bed" class="text-3xl font-extrabold text-slate-800 tracking-tighter">--:--</div>
                </div>
                <div class="p-4 rounded-3xl bg-white border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Target Wake Up</p>
                    <div id="res-wake" class="text-3xl font-extrabold text-slate-800 tracking-tighter">--:--</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm space-y-6">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Rolling
                Calculation (Night <span class="prev-n">N-1</span> + Night <span class="curr-n">N</span>)</h3>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 1: Bedtime Average</p>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-[11px] space-y-2">
                    <div class="flex justify-between">
                        <span>Night <span class="prev-n">--</span> (Stored):</span> <span id="bt-1"
                            class="math-font text-slate-400">--:--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Night <span class="curr-n">--</span> (New):</span> <span id="bt-2"
                            class="math-font text-indigo-600">--:--</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-200 pt-2 text-indigo-600">
                        <span class="font-bold uppercase">Rolling Anchor:</span> <span id="anchor-val"
                            class="math-font">--:--</span>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 2: Efficiency Average</p>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-[11px] space-y-3">
                    <div class="space-y-1">
                        <div class="flex justify-between text-slate-500">
                            <span>SOL: (Prev: <span id="s-prev">0</span>m + New: <span id="s-curr">0</span>m) / 2</span>
                        </div>
                        <div class="flex justify-between font-bold text-slate-700">
                            <span>Avg SOL:</span> <span id="avg-sol" class="math-font">--m</span>
                        </div>
                    </div>
                    <div class="space-y-1 border-t border-slate-200 pt-2">
                        <div class="flex justify-between text-slate-500">
                            <span>WASO: (Prev: <span id="w-prev">0</span>m + New: <span id="w-curr">0</span>m) /
                                2</span>
                        </div>
                        <div class="flex justify-between font-bold text-slate-700">
                            <span>Avg WASO:</span> <span id="avg-waso" class="math-font">--m</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 3: Prescription Rule</p>
                <div id="logic-box" class="p-3 rounded-xl border-2 border-dashed flex items-center justify-between">
                    <span id="logic-text" class="text-[11px] font-medium text-slate-700 italic">Processing...</span>
                    <span id="logic-shift" class="text-xs font-black px-2 py-1 rounded-lg">--</span>
                </div>
            </div>

            <button onclick="resetHistory()"
                class="w-full text-[9px] text-slate-300 underline uppercase tracking-widest hover:text-red-400 transition-colors">Reset
                History</button>
        </div>
    </div>

    <script>
        const p = new URLSearchParams(window.location.search);

        const tToM = (t) => {
            if (!t) return 0;
            let str = t.toLowerCase().trim();
            const isPm = str.includes('pm'), isAm = str.includes('am');
            const parts = str.replace(/[apm\s]/g, '').split(/[:.\s]/);
            let h = parseInt(parts[0]) || 0, m = parseInt(parts[1]) || 0;
            if (isPm && h < 12) h += 12;
            if (isAm && h === 12) h = 0;
            return (h * 60) + m;
        };

        const mToT = (m, simple = false) => {
            let tm = Math.round(m / 5) * 5;
            while (tm < 0) tm += 1440;
            tm %= 1440;
            let h = Math.floor(tm / 60), mins = tm % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return simple ? `${h}:${String(mins).padStart(2, '0')} ${ampm}` : `${h}:${String(mins).padStart(2, '0')}<span class="text-base ml-1 font-bold text-slate-400">${ampm}</span>`;
        };

        function resetHistory() {
            if (confirm("Clear rolling memory?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function calculate() {
            // 1. Determine Night Labels
            const dayNum = parseInt(p.get('day') || 9);
            document.querySelectorAll('.curr-n').forEach(e => e.innerText = dayNum - 1);
            document.querySelectorAll('.prev-n').forEach(e => e.innerText = dayNum - 2);

            // 2. Fetch "Current" Data from the Day 8 data slots
            const currBed = p.get('sleep_intervention_bedtime');
            const currSOL = parseInt(p.get('day_8_SOL') || 0);
            const currWASO = parseInt(p.get('day_8_WASO') || 0);
            const targetWake = tToM(p.get('base_wake') || "07:00");

            // 3. Fetch "Previous" Data from LocalStorage (Persistence)
            // If no history exists, it defaults to the current values (no change)
            const prevBed = localStorage.getItem('last_bedtime') || currBed;
            const prevSOL = parseInt(localStorage.getItem('last_sol') || currSOL);
            const prevWASO = parseInt(localStorage.getItem('last_waso') || currWASO);

            // UI Updates for Breakdown
            document.getElementById('bt-1').innerText = mToT(tToM(prevBed), true);
            document.getElementById('bt-2').innerText = mToT(tToM(currBed), true);
            document.getElementById('s-prev').innerText = prevSOL;
            document.getElementById('s-curr').innerText = currSOL;
            document.getElementById('w-prev').innerText = prevWASO;
            document.getElementById('w-curr').innerText = currWASO;

            // 4. Calculate Averages
            const anchorMins = (tToM(prevBed) + tToM(currBed)) / 2;
            const avgS = (prevSOL + currSOL) / 2;
            const avgW = (prevWASO + currWASO) / 2;

            document.getElementById('anchor-val').innerText = mToT(anchorMins, true);
            document.getElementById('avg-sol').innerText = avgS + "m";
            document.getElementById('avg-waso').innerText = avgW + "m";

            // 5. Apply Rules
            const success = (avgS <= 15 && avgW <= 15);
            let targetBed = success ? anchorMins - 15 : anchorMins + 15;

            const box = document.getElementById('logic-box');
            const shift = document.getElementById('logic-shift');
            if (success) {
                box.className = "p-3 rounded-xl border-2 border-dashed border-emerald-100 bg-emerald-50/30 flex items-center justify-between";
                shift.innerText = "-15m";
                document.getElementById('logic-text').innerText = "Goals met; window expanding.";
            } else {
                box.className = "p-3 rounded-xl border-2 border-dashed border-amber-100 bg-amber-50/30 flex items-center justify-between";
                shift.innerText = "+15m";
                document.getElementById('logic-text').innerText = "Goals missed; window condensed.";
            }

            // 6. Save current data to be the "Previous" data for the next visit
            localStorage.setItem('last_bedtime', currBed);
            localStorage.setItem('last_sol', currSOL);
            localStorage.setItem('last_waso', currWASO);

            document.getElementById('res-bed').innerHTML = mToT(targetBed);
            document.getElementById('res-wake').innerHTML = mToT(targetWake);
        }

        window.onload = calculate;
    </script>
</body>

</html>