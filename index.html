<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sleep Intervention: Rolling Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');

        html,
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .math-font {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>

<body class="p-4">
    <div class="max-w-xl mx-auto space-y-4">
        <div class="bg-transparent p-4 text-center border-b border-slate-100 pb-6">
            <div id="status-tag"
                class="inline-block px-4 py-1 rounded-full text-[10px] font-black uppercase mb-4 tracking-widest bg-emerald-600 text-white">
                Rolling Adjustment Active
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 rounded-3xl bg-white border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest mb-1">Target Bedtime</p>
                    <div id="res-bed" class="text-3xl font-extrabold text-slate-800 tracking-tighter">--:--</div>
                </div>
                <div class="p-4 rounded-3xl bg-white border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Target Wake Up</p>
                    <div id="res-wake" class="text-3xl font-extrabold text-slate-800 tracking-tighter">--:--</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm space-y-6">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Calculation
                Breakdown</h3>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 1: Bedtime Average
                    (Anchor)</p>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-[11px] space-y-2">
                    <div class="flex justify-between">
                        <span>Night 8 Bedtime:</span> <span id="bt-1" class="math-font">--:--</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Night 9 Bedtime:</span> <span id="bt-2" class="math-font">--:--</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-200 pt-2 text-indigo-600">
                        <span class="font-bold uppercase">Average Anchor:</span> <span id="anchor-val"
                            class="math-font">--:--</span>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 2: Efficiency Average
                    (Night 8 & 9)</p>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-[11px] space-y-3">
                    <div class="space-y-1">
                        <div class="flex justify-between text-slate-500">
                            <span>SOL: (Night 8: <span id="s8-val">0</span>m + Night 9: <span id="s9-val">0</span>m) /
                                2</span>
                        </div>
                        <div class="flex justify-between font-bold text-slate-700">
                            <span>Average SOL:</span> <span id="avg-sol" class="math-font">--m</span>
                        </div>
                    </div>
                    <div class="space-y-1 border-t border-slate-200 pt-2">
                        <div class="flex justify-between text-slate-500">
                            <span>WASO: (Night 8: <span id="w8-val">0</span>m + Night 9: <span id="w9-val">0</span>m) /
                                2</span>
                        </div>
                        <div class="flex justify-between font-bold text-slate-700">
                            <span>Average WASO:</span> <span id="avg-waso" class="math-font">--m</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Step 3: Apply Prescription Rule
                </p>
                <div id="logic-box" class="p-3 rounded-xl border-2 border-dashed flex items-center justify-between">
                    <span id="logic-text" class="text-[11px] font-medium text-slate-700 italic">Processing...</span>
                    <span id="logic-shift" class="text-xs font-black px-2 py-1 rounded-lg">--</span>
                </div>
            </div>

            <div id="safeguard-row"
                class="hidden bg-amber-50 p-3 rounded-xl border border-amber-100 flex items-center gap-2">
                <span class="text-lg">⚠️</span>
                <span class="text-[11px] text-amber-800 leading-tight font-bold">Safeguard: 8-hour window
                    enforced.</span>
            </div>

            <button onclick="resetHistory()"
                class="w-full text-[9px] text-slate-300 underline uppercase tracking-widest hover:text-red-400 transition-colors">Reset
                Rolling History</button>
        </div>
    </div>

    <script>
        const p = new URLSearchParams(window.location.search);

        const tToM = (t) => {
            if (!t) return 0;
            let str = t.toLowerCase().trim();
            const isPm = str.includes('pm'), isAm = str.includes('am');
            const parts = str.replace(/[apm\s]/g, '').split(/[:.\s]/);
            let h = parseInt(parts[0]) || 0, m = parseInt(parts[1]) || 0;
            if (isPm && h < 12) h += 12;
            if (isAm && h === 12) h = 0;
            if (!isAm && !isPm && h >= 8 && h <= 11) h += 12;
            return (h * 60) + m;
        };

        const mToT = (m, simple = false) => {
            let tm = Math.round(m / 5) * 5;
            while (tm < 0) tm += 1440;
            tm %= 1440;
            let h = Math.floor(tm / 60), mins = tm % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return simple ? `${h}:${String(mins).padStart(2, '0')} ${ampm}` : `${h}:${String(mins).padStart(2, '0')}<span class="text-base ml-1 font-bold text-slate-400">${ampm}</span>`;
        };

        function resetHistory() {
            if (confirm("Reset rolling history?")) {
                localStorage.removeItem('stored_bt_n8');
                location.reload();
            }
        }

        function calculate() {
            const targetWake = tToM(p.get('base_wake') || "07:00");

            // Mapping: Night 8 (prev day 8) and Night 9 (current intervention)
            let n8_bed = localStorage.getItem('stored_bt_n8') || p.get('day_8_bedtime');
            let n9_bed = p.get('sleep_intervention_bedtime');

            if (!n8_bed) n8_bed = p.get('base_bed');
            if (!n9_bed) n9_bed = n8_bed;

            const n8Mins = tToM(n8_bed);
            const n9Mins = tToM(n9_bed);
            const anchorMins = (n8Mins + n9Mins) / 2;

            document.getElementById('bt-1').innerText = mToT(n8Mins, true);
            document.getElementById('bt-2').innerText = mToT(n9Mins, true);
            document.getElementById('anchor-val').innerText = mToT(anchorMins, true);

            // Efficiency Values
            const s8 = parseInt(p.get('day_8_SOL') || 0), w8 = parseInt(p.get('day_8_WASO') || 0);
            const s9 = parseInt(p.get('sleep_intervention_SOL') || 0), w9 = parseInt(p.get('sleep_intervention_WASO') || 0);

            document.getElementById('s8-val').innerText = s8;
            document.getElementById('s9-val').innerText = s9;
            document.getElementById('w8-val').innerText = w8;
            document.getElementById('w9-val').innerText = w9;

            const avgS = (s8 + s9) / 2, avgW = (w8 + w9) / 2;
            document.getElementById('avg-sol').innerText = avgS + "m";
            document.getElementById('avg-waso').innerText = avgW + "m";

            // Calculation
            const success = (avgS <= 15 && avgW <= 15);
            let targetBed = success ? anchorMins - 15 : anchorMins + 15;

            const box = document.getElementById('logic-box');
            const shift = document.getElementById('logic-shift');
            if (success) {
                box.className = "p-3 rounded-xl border-2 border-dashed border-emerald-100 bg-emerald-50/30 flex items-center justify-between";
                shift.className = "text-xs font-black px-2 py-1 rounded-lg bg-emerald-600 text-white";
                shift.innerText = "-15m";
                document.getElementById('logic-text').innerText = "Efficiency goals met.";
            } else {
                box.className = "p-3 rounded-xl border-2 border-dashed border-amber-100 bg-amber-50/30 flex items-center justify-between";
                shift.className = "text-xs font-black px-2 py-1 rounded-lg bg-amber-600 text-white";
                shift.innerText = "+15m";
                document.getElementById('logic-text').innerText = "Goals not met; window condensed.";
            }

            // Safeguard
            let checkWake = targetWake;
            let checkBed = targetBed % 1440;
            if (checkWake <= checkBed) checkWake += 1440;
            if ((checkWake - checkBed) < 480) {
                targetBed = targetWake - 480;
                document.getElementById('safeguard-row').classList.remove('hidden');
            }

            // Persistence
            localStorage.setItem('stored_bt_n8', n9_bed);

            document.getElementById('res-bed').innerHTML = mToT(targetBed);
            document.getElementById('res-wake').innerHTML = mToT(targetWake);
        }

        window.onload = calculate;
    </script>
</body>

</html>